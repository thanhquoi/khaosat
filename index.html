<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kh·∫£o s√°t √Ω ki·∫øn, nguy·ªán v·ªçng c·ªßa ng∆∞·ªùi d√¢n</title>
<link rel="preconnect" href="https://fonts.gstatic.com">
<style>
  @font-face{
    font-family:InterVar;
    src: local('Inter'), local('Arial');
  }
  body{
    margin:0;
    font-family: InterVar, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    background: linear-gradient(180deg,#f4f8ff,#ffffff);
    color:#0f172a;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    padding:28px;
  }
  .wrap{
    max-width:980px;
    margin:0 auto;
  }
  .hero{
    display:flex;
    gap:16px;
    align-items:center;
    margin-bottom:18px;
  }
  .logo{
    width:84px;height:84px;border-radius:12px;overflow:hidden;flex:0 0 84px;background:#fff;display:flex;align-items:center;justify-content:center;
    box-shadow:0 8px 30px rgba(15,23,42,0.06);
  }
  .logo img{max-width:100%;max-height:100%;display:block}
  h1{font-size:20px;margin:0 0 6px 0}
  p.lead{margin:0;color:#475569;font-size:14px}

  .card{
    background:linear-gradient(180deg,#ffffff,#fbfdff);
    border-radius:14px;
    padding:18px;
    box-shadow:0 10px 40px rgba(2,6,23,0.04);
    margin-bottom:18px;
  }

  /* field buttons grid */
  .fields{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
    gap:12px;
  }
  .field-btn{
    background:linear-gradient(180deg,#2b7cff,#1f5fd6);
    color:white;padding:12px;border-radius:12px;border:0;font-weight:700;cursor:pointer;
    box-shadow:0 8px 20px rgba(43,124,255,0.12);
    transition:transform .14s ease, box-shadow .14s ease;
    text-align:center;
  }
  .field-btn.secondary{ background:linear-gradient(180deg,#0ea5a4,#047a72); box-shadow:0 8px 20px rgba(14,165,164,0.12); }
  .field-btn.warn{ background:linear-gradient(180deg,#f97316,#d65d00); box-shadow:0 8px 20px rgba(249,115,22,0.12); }
  .field-btn:hover{ transform:translateY(-6px) }

  .form-row{ display:flex; gap:14px; margin-top:14px; flex-wrap:wrap; }
  .form-col{ flex:1; min-width:210px; }

  label{ display:block; font-weight:600; margin-bottom:6px; color:#0f172a; font-size:14px }
  input, textarea, select{
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid #e6eefc; background:#fbfdff;
    font-size:15px; color:#0f172a;
    box-shadow:inset 0 1px 0 rgba(255,255,255,0.6);
  }
  textarea{ min-height:110px; resize:vertical; }

  .actions{ display:flex; gap:12px; margin-top:14px; align-items:center; flex-wrap:wrap; }
  .btn{
    border:0; padding:12px 16px; border-radius:12px; cursor:pointer; font-weight:700;
    box-shadow:0 8px 26px rgba(2,6,23,0.06);
  }
  .btn.primary{ background:linear-gradient(180deg,#10b981,#059669); color:white }
  .btn.ghost{ background:transparent; border:1px solid #e6eefc; color:#0f172a }
  .btn.export{ background:linear-gradient(180deg,#8b5cf6,#6d28d9); color:white }
  .btn.reset{ background:linear-gradient(180deg,#ef4444,#dc2626); color:white }

  .note{ color:#6b7280; font-size:13px; margin-top:10px }

  footer{ text-align:center; color:#64748b; font-size:13px; margin-top:18px }

  @media(max-width:720px){
    .hero{ flex-direction:column; align-items:flex-start}
    .form-row{ flex-direction:column }
  }
  div .ali{ text-align: center; }
</style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      
      <div class="ali">
        <img scr= "logo.png" />
        <h1>TRUNG T√ÇM PH·ª§C V·ª§ H√ÄNH CH√çNH C√îNG X√É TH·∫†NH QU·ªöI</h1>
        <h1>Kh·∫£o s√°t √Ω ki·∫øn c·ªßa ng∆∞·ªùi d√¢n v·ªÅ c·∫£i c√°ch h√†nh ch√≠nh - chuy·ªÉn ƒë·ªïi s·ªë - ph√°t tri·ªÉn kinh t·∫ø - x√£ h·ªôi</h1>
       
      </div>
    </div>

    <div class="card">
      <div style="font-weight:800;margin-bottom:12px">Ch·ªçn lƒ©nh v·ª±c</div>
      <div class="fields" role="list">
        <button class="field-btn" onclick="selectField('Y t·∫ø - Gi√°o d·ª•c')">Y t·∫ø - Gi√°o d·ª•c</button>
        <button class="field-btn secondary" onclick="selectField('ƒê·∫•t ƒëai')">ƒê·∫•t ƒëai</button>
        <button class="field-btn" onclick="selectField('N√¥ng nghi·ªáp - M√¥i tr∆∞·ªùng')">N√¥ng nghi·ªáp - M√¥i tr∆∞·ªùng</button>
        <button class="field-btn warn" onclick="selectField('S·∫£n xu·∫•t - Kinh doanh')">S·∫£n xu·∫•t - Kinh doanh</button>
        <button class="field-btn" onclick="selectField('ChƒÉn nu√¥i - Th·ªßy s·∫£n')">ChƒÉn nu√¥i - Th·ªßy s·∫£n</button>
        <button class="field-btn secondary" onclick="selectField('Kh√°c')">Kh√°c</button>
      </div>

      <div id="formArea" style="display:none; margin-top:18px">
        <div id="otherField" style="display:none;margin-bottom:10px">
          <label>Lƒ©nh v·ª±c (kh√°c):</label>
          <input id="otherInput" placeholder="Nh·∫≠p lƒ©nh v·ª±c kh√°c (v√≠ d·ª•: Giao th√¥ng...)" />
        </div>

        <div class="form-row">
          <div class="form-col">
            <label>H·ªç v√† t√™n</label>
            <input id="name" placeholder="V√≠ d·ª•: Nguy·ªÖn VƒÉn A">
          </div>
          <div class="form-col">
            <label>ƒê·ªãa ch·ªâ</label>
            <input id="address" placeholder="V√≠ d·ª•: ·∫•p Qui L√¢n 6, x√£ Th·∫°nh Qu·ªõi">
          </div>
        </div>

        <div class="form-row">
          <div class="form-col">
            <label>S·ªë ƒëi·ªán tho·∫°i</label>
            <input id="phone" placeholder="V√≠ d·ª•: 09xxxxxxxx">
          </div>
          <div class="form-col">
            <label>Th·ªùi ƒëi·ªÉm (t√πy ch·ªçn)</label>
            <input id="time" type="datetime-local" />
          </div>
        </div>

        <div style="margin-top:10px">
          <label>√ù ki·∫øn c√° nh√¢n</label>
          <textarea id="opinion" placeholder="Ghi √Ω ki·∫øn, nguy·ªán v·ªçng..."></textarea>
        </div>

        <div class="actions">
          <button class="btn primary" id="submitBtn" onclick="submitForm()">G·ª≠i kh·∫£o s√°t</button>
          <button class="btn export" id="exportBtn" onclick="exportExcel()">üì• Xu·∫•t Excel (.xlsx)</button>
          <button class="btn reset" id="resetBtn" onclick="askReset()">üîí Reset d·ªØ li·ªáu</button>
        </div>

        <div class="note">Ghi ch√∫: Reset d·ªØ li·ªáu y√™u c·∫ßu m·∫≠t kh·∫©u qu·∫£n tr·ªã.</div>
      </div>
    </div>

    <footer>¬© Trung t√¢m Ph·ª•c v·ª• H√†nh ch√≠nh c√¥ng ‚Äî Trang kh·∫£o s√°t</footer>
  </div>

  <!-- ExcelJS + FileSaver (non-module globals) -->
  <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

  <!-- Firebase module -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getDatabase,
      ref,
      push,
      remove,
      get,
      onValue
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

    // Firebase config (b·∫°n ƒë√£ cung c·∫•p)
    const firebaseConfig = {
      apiKey: "AIzaSyDFIxo2xXu6X4C616cwW6ZbE-pxxLzodrs",
      authDomain: "danhgiahailong-39491.firebaseapp.com",
      databaseURL: "https://danhgiahailong-39491-default-rtdb.firebaseio.com",
      projectId: "danhgiahailong-39491",
      storageBucket: "danhgiahailong-39491.firebasestorage.app",
      messagingSenderId: "774652192762",
      appId: "1:774652192762:web:75370364318e8a81446643"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // UI helpers
    let selectedField = "";

    window.selectField = function(field) {
      selectedField = field;
      document.getElementById('formArea').style.display = 'block';
      if(field === 'Kh√°c') {
        document.getElementById('otherField').style.display = 'block';
      } else {
        document.getElementById('otherField').style.display = 'none';
      }
      // scroll to form
      setTimeout(()=> document.getElementById('submitBtn').scrollIntoView({behavior:'smooth', block:'center'}), 150);
    };

    // Submit survey: save to 'survey' node with timestamp
    window.submitForm = async function() {
      if(!selectedField) { alert('Vui l√≤ng ch·ªçn lƒ©nh v·ª±c tr∆∞·ªõc khi g·ª≠i.'); return; }

      let field = selectedField;
      if(field === 'Kh√°c'){
        field = (document.getElementById('otherInput').value || '').trim();
        if(!field){ alert('Vui l√≤ng nh·∫≠p lƒ©nh v·ª±c kh√°c.'); return; }
      }

      const payload = {
        field,
        name: (document.getElementById('name').value || '').trim(),
        address: (document.getElementById('address').value || '').trim(),
        phone: (document.getElementById('phone').value || '').trim(),
        opinion: (document.getElementById('opinion').value || '').trim(),
        givenTime: (document.getElementById('time').value) ? new Date(document.getElementById('time').value).toISOString() : null,
        timestamp: Date.now()
      };

      try {
        await push(ref(db, 'survey'), payload);
        alert('C·∫£m ∆°n! √ù ki·∫øn c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c g·ª≠i.');
        // reset form UI
        document.getElementById('name').value = '';
        document.getElementById('address').value = '';
        document.getElementById('phone').value = '';
        document.getElementById('opinion').value = '';
        document.getElementById('time').value = '';
        document.getElementById('otherInput').value = '';
        document.getElementById('formArea').style.display = 'none';
        selectedField = '';
      } catch (e) {
        console.error(e);
        alert('C√≥ l·ªói khi g·ª≠i d·ªØ li·ªáu ‚Äî vui l√≤ng th·ª≠ l·∫°i.');
      }
    };

    // Export using ExcelJS (set Times New Roman font)
    window.exportExcel = async function() {
      try {
        // Read all survey data once
        const snapshot = await get(ref(db, 'survey'));
        const data = snapshot.exists() ? snapshot.val() : {};

        // Create workbook & sheet
        const workbook = new ExcelJS.Workbook();
        workbook.creator = 'Kh·∫£o s√°t';
        workbook.created = new Date();
        const sheet = workbook.addWorksheet('Kh·∫£o s√°t');

        // Define columns
        sheet.columns = [
          { header: 'Lƒ©nh v·ª±c', key: 'field', width: 30 },
          { header: 'H·ªç v√† t√™n', key: 'name', width: 25 },
          { header: 'ƒê·ªãa ch·ªâ', key: 'address', width: 40 },
          { header: 'S·ªë ƒëi·ªán tho·∫°i', key: 'phone', width: 18 },
          { header: '√ù ki·∫øn', key: 'opinion', width: 60 },
          { header: 'Th·ªùi ƒëi·ªÉm khai b√°o', key: 'givenTime', width: 22 },
          { header: 'Th·ªùi ƒëi·ªÉm l∆∞u', key: 'timestamp', width: 22 }
        ];

        // Add rows
        for(const id in data) {
          const r = data[id] || {};
          sheet.addRow({
            field: r.field || '',
            name: r.name || '',
            address: r.address || '',
            phone: r.phone || '',
            opinion: r.opinion || '',
            givenTime: r.givenTime ? new Date(r.givenTime).toLocaleString() : '',
            timestamp: r.timestamp ? new Date(r.timestamp).toLocaleString() : ''
          });
        }

        // Set font for all cells (header + body)
        sheet.eachRow((row, rowNumber) => {
          row.eachCell((cell) => {
            cell.font = { name: 'Times New Roman', size: 12 };
            // header bold
            if(rowNumber === 1) cell.font = { name: 'Times New Roman', size: 12, bold: true };
            cell.alignment = { vertical: 'middle', wrapText: true };
          });
        });

        // Auto-filter on header
        sheet.autoFilter = { from: 'A1', to: 'G1' };

        // Generate buffer and trigger download
        const buf = await workbook.xlsx.writeBuffer();
        const now = new Date();
        const fname = `KhaoSat_${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}.xlsx`;
        saveAs(new Blob([buf]), fname);

      } catch (err) {
        console.error('Export error', err);
        alert('Kh√¥ng xu·∫•t ƒë∆∞·ª£c file Excel ‚Äî ki·ªÉm tra console.');
      }
    };

    // Ask for password then reset (delete) the 'survey' node
    window.askReset = function() {
      const pass = prompt('Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ reset d·ªØ li·ªáu:');
      if(pass === null) return; // user cancelled
      if(pass === '0342731391') {
        if(!confirm('X√°c nh·∫≠n: b·∫°n mu·ªën x√≥a to√†n b·ªô d·ªØ li·ªáu kh·∫£o s√°t?')) return;
        remove(ref(db, 'survey')).then(()=> {
          alert('ƒê√£ reset d·ªØ li·ªáu.');
        }).catch(err=>{
          console.error(err);
          alert('L·ªói khi reset d·ªØ li·ªáu.');
        });
      } else {
        alert('Sai m·∫≠t kh·∫©u.');
      }
    };

    // Optional: small realtime listener (not necessary) to keep page fresh if admin watching
    onValue(ref(db, 'survey'), () => {
      // no-op; this keeps realtime connection active (optional)
    });

  </script>
</body>
</html>


